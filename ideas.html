<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
                <style>
            div.charts li {
                display: block;
                float: left;
                width: 20%;
            }

            div.charts label {
                display: block;
            }

            div.charts {
                clear: both;
                margin-bottom: 20px;
            }

            .node {
                font: 300 13px "Helvetica Neue", Helvetica, Arial, sans-serif;
                fill: #bbb;
                cursor: pointer;
            }

            .node.event {
                fill: orange;
            }

            .node.chart {
                fill: teal;
            }

            .link {
                stroke: #efefef;
                stroke-opacity: 1;
                fill: none;
                pointer-events: none;
            }

            .node:hover,
            .node--source,
            .node--target {
                font-weight: 700;
                font-size: 15px;
            }

            .node--source {
                fill: teal;
            }

            .node--target {
                fill: orange;
            }

            .link--source,
            .link--target {
                stroke-opacity: 1;
                stroke-width: 1px;
            }

            .link--source {
                stroke: orange;
            }

            .link--target {
                stroke: teal; 
            }
        </style>
        <script type="text/javascript" src="d3/d3.v3.js"></script>
    </head>
    <body>
        <div class="filters">
            <form>
                <ul>
                    <li><label><input type="radio" name="filter" checked="checked" value="">None</label></li>
                    <li><label><input type="radio" name="filter" value="Celery Root/Celeriac">Celery Root/Celeriac</label></li>
                    <li><label><input type="radio" name="filter" value="Iceberg">Iceberg</label></li>
                    <li><label><input type="radio" name="filter" value="Ornamental">Ornamental</label></li>
                </ul>
            </form>
        </div>
        <div class="canvas">

        </div>
        <script type="text/javascript">
             var myData = [{"imports": ["Rutabaga", "Mustard Greens"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Sweet Potato", "sub-section": "Grape Leaves"}, {"imports": ["Rutabaga"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Turnip Greens", "sub-section": "Grape Leaves"}, {"imports": ["Rutabaga"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Romaine", "sub-section": "Grape Leaves"}, {"imports": ["Rutabaga", "Mustard Greens"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Celery", "sub-section": "Grape Leaves"}, {"imports": ["Mustard Greens"], "section": "Beet", "type": "chart", "name": "", "sub-section": "Dandelion Greens"}, {"imports": ["Endive", "Mustard Greens"], "section": "Iceberg", "type": "chart", "name": "Cassava/Yuca", "sub-section": "Pumpkin"}, {"imports": ["Endive", "Mustard Greens"], "section": "Iceberg", "type": "chart", "name": "Parsnip", "sub-section": "Pumpkin"}, {"imports": ["Endive", "Mustard Greens"], "section": "Iceberg", "type": "chart", "name": "Water Chestnut", "sub-section": "Pumpkin"}, {"imports": ["Rutabaga", "Mustard Greens"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Jerusalem Artichoke/Sunchokes", "sub-section": "Grape Leaves"}, {"imports": ["Parsley Root", "Nopales", "Sea Vegetables- see Sea Vegetable List", "Kale"], "section": "Iceberg", "type": "chart", "name": "Taro", "sub-section": "Collard Greens"}, {"imports": ["Mustard Greens"], "section": "Iceberg", "type": "chart", "name": "Radish", "sub-section": "Pumpkin"}, {"imports": ["Mustard Greens"], "section": "Iceberg", "type": "chart", "name": "Garlic", "sub-section": "Pumpkin"}, {"imports": ["Plantain", "Mustard Greens"], "section": "Iceberg", "type": "chart", "name": "Peas", "sub-section": "Kohlrabi Greens"}, {"imports": ["Chayote"], "section": "Iceberg", "type": "chart", "name": "Curly", "sub-section": "Kohlrabi Greens"}, {"imports": ["Leeks", "Chayote"], "section": "Iceberg", "type": "chart", "name": "Leaf- Green Leaf, Red Leaf", "sub-section": "Kohlrabi Greens"}, {"imports": ["Leeks"], "section": "Iceberg", "type": "chart", "name": "Broccoli", "sub-section": "Kohlrabi Greens"}, {"imports": ["Rutabaga"], "section": "Iceberg", "type": "chart", "name": "Yams", "sub-section": "Collard Greens"}, {"imports": ["Chayote", "Mustard Greens"], "section": "Iceberg", "type": "chart", "name": "Burdock Root/Gobo", "sub-section": "Kohlrabi Greens"}, {"imports": ["Rutabaga"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Brussels Sprouts", "sub-section": "Lettuce"}, {"imports": ["Rutabaga"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Bok Choy/Bok Choi/Pak Choy", "sub-section": "Spinach"}, {"imports": ["Rutabaga", "Mustard Greens"], "section": "Beet", "type": "chart", "name": "Winter Melon", "sub-section": "Squash- see Squash List"}, {"imports": ["Rutabaga", "Mustard Greens"], "section": "Beet", "type": "chart", "name": "Radicchio", "sub-section": "Onion"}, {"imports": ["Rutabaga", "Endive"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Ginger", "sub-section": "Grape Leaves"}, {"imports": ["Rutabaga", "Endive"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Shallots", "sub-section": "Grape Leaves"}, {"imports": ["Rutabaga", "Endive"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Peppers- see Peppers List", "sub-section": "Grape Leaves"}, {"imports": ["Rutabaga", "Mustard Greens"], "section": "Beet", "type": "chart", "name": "Horseradish", "sub-section": "Squash- see Squash List"}, {"imports": ["Rutabaga", "Mustard Greens"], "section": "Beet", "type": "chart", "name": "Edamame", "sub-section": "Onion"}, {"imports": ["Rutabaga", "Mustard Greens"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Galangal", "sub-section": "Grape Leaves"}, {"imports": ["Leeks", "Chayote", "Plantain", "Lotus Root", "Lotus Seed", "Arugula", "Mustard Greens"], "section": "Iceberg", "type": "chart", "name": "Bell Pepper", "sub-section": "Kohlrabi Greens"}, {"imports": ["Leeks", "Chayote", "Plantain", "Lotus Root", "Lotus Seed", "Arugula", "Mustard Greens"], "section": "Iceberg", "type": "chart", "name": "Amaranth Leaves/Chinese Spinach", "sub-section": "Kohlrabi Greens"}, {"imports": ["Rutabaga", "Mustard Greens"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Beet Greens", "sub-section": "Spinach"}, {"imports": ["Mustard Greens"], "section": "Beet", "type": "chart", "name": "Greens", "sub-section": "Squash- see Squash List"}, {"imports": ["Mustard Greens"], "section": "Beet", "type": "chart", "name": "Pickling Cucumbers", "sub-section": "Onion"}, {"imports": ["Rutabaga"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Green, Purple, White", "sub-section": "Wax Beans"}, {"imports": ["Mustard Greens"], "section": "Green Beans/String Beans/Snap Beans", "type": "chart", "name": "Napa Cabbage", "sub-section": "Capers"}, {"imports": ["Rutabaga", "Mustard Greens"], "section": "Green Beans/String Beans/Snap Beans", "type": "chart", "name": "Olive", "sub-section": "Capers"}, {"imports": ["Mustard Greens"], "section": "Beet", "type": "chart", "name": "Beet", "sub-section": "Dandelion Greens"}, {"imports": ["Mustard Greens"], "section": "Beet", "type": "chart", "name": "Artichoke", "sub-section": "Artichoke"}, {"imports": ["Rutabaga"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Purslane", "sub-section": "Spinach"}, {"imports": ["Rutabaga"], "section": "Beet", "type": "chart", "name": "J\u00edcama", "sub-section": "Squash- see Squash List"}, {"imports": ["Rutabaga", "Mustard Greens"], "section": "Beet", "type": "chart", "name": "English Cucumber", "sub-section": "Onion"}, {"imports": ["Rutabaga"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Bean Sprouts", "sub-section": "Wax Beans"}, {"imports": ["Mustard Greens"], "section": "Beet", "type": "chart", "name": "Turnip", "sub-section": "Dandelion Greens"}, {"imports": ["Rutabaga"], "section": "Iceberg", "type": "chart", "name": "Hearts of Palm", "sub-section": "Collard Greens"}, {"imports": ["Parsley Root"], "section": "Iceberg", "type": "chart", "name": "Elephant Garlic", "sub-section": "Collard Greens"}, {"imports": ["Mustard Greens"], "section": "Ornamental", "type": "chart", "name": "Eggplant/Aubergine", "sub-section": "Okra"}, {"imports": ["Endive"], "section": "Iceberg", "type": "chart", "name": "Celtuce", "sub-section": "Pumpkin"}, {"imports": ["Parsley Root", "Sea Vegetables- see Sea Vegetable List", "Kale", "Nopales"], "section": "Iceberg", "type": "chart", "name": "Zucchini", "sub-section": "Collard Greens"}, {"imports": ["Rutabaga"], "section": "Ornamental", "type": "chart", "name": "Water Spinach", "sub-section": "Okra"}, {"imports": ["Rutabaga", "Mustard Greens"], "section": "Ornamental", "type": "chart", "name": "Watercress", "sub-section": "Okra"}, {"imports": ["Mustard Greens"], "section": "Ornamental", "type": "chart", "name": "Carrot", "sub-section": "Okra"}, {"imports": ["Rutabaga"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Corn/Maize", "sub-section": "Grape Leaves"}, {"imports": ["Rutabaga"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Asparagus", "sub-section": "Spinach"}, {"imports": ["Rutabaga"], "section": "Beet", "type": "chart", "name": "Cabbage", "sub-section": "Squash- see Squash List"}, {"imports": ["Rutabaga", "Mustard Greens"], "section": "Beet", "type": "chart", "name": "Gherkin", "sub-section": "Onion"}, {"imports": ["Rutabaga"], "section": "Celery Root/Celeriac", "type": "chart", "name": "Green Onions/Scallions", "sub-section": "Wax Beans"}, {"imports": ["Sweet Potato", "Celery", "", "Cassava/Yuca", "Parsnip", "Water Chestnut", "Jerusalem Artichoke/Sunchokes", "Radish", "Garlic", "Peas", "Burdock Root/Gobo", "Winter Melon", "Radicchio", "Horseradish", "Edamame", "Galangal", "Bell Pepper", "Amaranth Leaves/Chinese Spinach", "Beet Greens", "Greens", "Pickling Cucumbers", "Napa Cabbage", "Olive", "Beet", "Artichoke", "English Cucumber", "Turnip", "Eggplant/Aubergine", "Watercress", "Carrot", "Gherkin"], "section": "green peas", "type": "event", "name": "Mustard Greens", "sub-section": "green peas"}, {"imports": ["Bell Pepper", "Amaranth Leaves/Chinese Spinach"], "section": "green peas", "type": "event", "name": "Lotus Root", "sub-section": "green peas"}, {"imports": ["Peas", "Bell Pepper", "Amaranth Leaves/Chinese Spinach"], "section": "green peas", "type": "event", "name": "Plantain", "sub-section": "green peas"}, {"imports": ["Curly", "Leaf- Green Leaf, Red Leaf", "Burdock Root/Gobo", "Bell Pepper", "Amaranth Leaves/Chinese Spinach"], "section": "green peas", "type": "event", "name": "Chayote", "sub-section": "green peas"}, {"imports": ["Leaf- Green Leaf, Red Leaf", "Broccoli", "Bell Pepper", "Amaranth Leaves/Chinese Spinach"], "section": "green peas", "type": "event", "name": "Leeks", "sub-section": "green peas"}, {"imports": ["Bell Pepper", "Amaranth Leaves/Chinese Spinach"], "section": "green peas", "type": "event", "name": "Arugula", "sub-section": "green peas"}, {"imports": ["Bell Pepper", "Amaranth Leaves/Chinese Spinach"], "section": "green peas", "type": "event", "name": "Lotus Seed", "sub-section": "green peas"}, {"imports": ["Taro", "Zucchini"], "section": "green peas", "type": "event", "name": "Kale", "sub-section": "green peas"}, {"imports": ["Taro", "Zucchini"], "section": "green peas", "type": "event", "name": "Nopales", "sub-section": "green peas"}, {"imports": ["Taro", "Zucchini"], "section": "green peas", "type": "event", "name": "Sea Vegetables- see Sea Vegetable List", "sub-section": "green peas"}, {"imports": ["Taro", "Elephant Garlic", "Zucchini"], "section": "green peas", "type": "event", "name": "Parsley Root", "sub-section": "green peas"}, {"imports": ["Cassava/Yuca", "Parsnip", "Water Chestnut", "Ginger", "Shallots", "Peppers- see Peppers List", "Celtuce"], "section": "green peas", "type": "event", "name": "Endive", "sub-section": "green peas"}, {"imports": ["Sweet Potato", "Turnip Greens", "Romaine", "Celery", "Jerusalem Artichoke/Sunchokes", "Yams", "Brussels Sprouts", "Bok Choy/Bok Choi/Pak Choy", "Winter Melon", "Radicchio", "Ginger", "Shallots", "Peppers- see Peppers List", "Horseradish", "Edamame", "Galangal", "Beet Greens", "Green, Purple, White", "Olive", "Purslane", "J\u00edcama", "English Cucumber", "Bean Sprouts", "Hearts of Palm", "Water Spinach", "Watercress", "Corn/Maize", "Asparagus", "Cabbage", "Gherkin", "Green Onions/Scallions"], "section": "green peas", "type": "event", "name": "Rutabaga", "sub-section": "green peas"}];

                var height = 600;
                var width = 800;

                //var cluster = d3.layout.cluster().size([360, innerRadius]);

                var cluster = d3.layout.tree()
                    .size([width, height]);

                var diagonal = d3.svg.diagonal()
                    .projection(function (d) {
                        if(d.type == "event") return [d.y-200, d.x-(width/2)];
                        return [d.y, d.x];
                    });

                var bundle = d3.layout.bundle();
               

                var drawIt = function(showWhat){
                    // Lazily construct the package hierarchy from class names.
                    d3.select("div.canvas").html("");

                    var svg = d3.select("div.canvas").append("svg")
                        .attr("width", width)
                        .attr("height", height)
                        .style("border", "1px solid pink");

                    function filterData(data, showWhat){
                        
                        var filtered = [];
                        var imports = {};
                        var availableImports = [];

                        data.forEach(function(d){
                            if(d.type == "chart"){
                                if(showWhat && (d.section == showWhat || d.section == "none")){
                                    filtered.push(d);
                                    if(d.imports) d.imports.forEach(function(i){imports[i] = true;});
                                }else if(!showWhat){
                                    filtered.push(d);
                                    if(d.imports) d.imports.forEach(function(i){imports[i] = true;});
                                }
                            }else{
                                availableImports.push(d);
                            }
                        });

                        availableImports.forEach(function(ai){
                            if(imports[ai.name]){
                                filtered.push(ai);
                            }
                        });

                        return filtered;
                    }


                    function packageHierarchy(classes) {
                        var map = {};

                        function find(name, data) {
                            var node = map[name], i;
                            if (!node) {
                                node = map[name] = data || {name: name, type: "", children: []};
                                if (name.length) {
                                    node.parent = find("");
                                    node.parent.children.push(node);
                                    node.key = name;
                                }
                            }
                            return node;
                        }

                        classes.forEach(function(d) {
                            find(d.name, d);
                        });

                        return map[""];
                    }

                    // Return a list of imports for the given array of nodes.
                    function packageImports(nodes) {
                        var map = {},
                        imports = [];

                        // Compute a map from name to node.
                        nodes.forEach(function(d) {
                            map[d.name] = d;
                        });

                        // For each import, construct a link from the source to target node.
                        nodes.forEach(function(d) {
                            if (d.imports) d.imports.forEach(function(i) {
                                if(map[i]) imports.push({source: map[d.name], target: map[i]});
                            });
                        });

                        return imports;
                    }


                    var link = svg.append("g").selectAll(".link"),
                    node = svg.append("g").selectAll(".node");

                    var filters = d3.select("div.filters");

                    var charts = d3.select("div.charts");
                    myData.forEach(function(d){
                        if(d.type == "chart"){
                            charts.append("li")
                                .append("label")
                                .text(d.name)
                                .append("input")
                                .attr("type", "checkbox");
                        }
                    });

                    var nodes = cluster.nodes(packageHierarchy(filterData(myData, showWhat)));
                    var links = packageImports(nodes);

                    link = link.data(bundle(links))
                        .enter().append("path")
                        .each(function(d) { 
                            d.source = d[0], 
                            d.target = d[d.length - 1]; 
                        })
                        .attr("class", "link")
                        //.attr("d", line);
                        .attr("d", diagonal); //get the new cluster path

                    node = node.data(nodes.filter(function(n) { return !n.children; }))
                        .enter().append("text")
                        .attr("class", function(d){ return "node " + d.type })
                        //.attr("dy", "1em")
                        //.attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + (d.y + 8) + ",0)" + (d.x < 180 ? "" : "rotate(180)"); })
                        .style("text-anchor", function(d) { return d.type == "chart" ? "start" : "end"; })
                        .attr("transform", function (d) {
                            if(d.type == "event"){
                                var y = d.y-200;
                                var x =  d.x-(width/2);
                                return "translate(" + y + "," + x + ")";
                            }
                            return "translate(" + d.y + "," + d.x + ")";
                        })
                        .text(function(d) { return d.key; })
                        .on("mouseover", mouseovered)
                        .on("mouseout", mouseouted);

                    function mouseovered(d) {
                        node.each(function(n) { n.target = n.source = false; });

                        link.classed("link--target", function(l) { if (l.target === d) return l.source.source = true; })
                            .classed("link--source", function(l) { if (l.source === d) return l.target.target = true; })
                            .filter(function(l) { return l.target === d || l.source === d; })
                            .each(function() { this.parentNode.appendChild(this); });

                        node.classed("node--target", function(n) { return n.target; })
                            .classed("node--source", function(n) { return n.source; });
                    }

                    function mouseouted(d) {
                        link.classed("link--target", false)
                            .classed("link--source", false);

                        node.classed("node--target", false)
                            .classed("node--source", false);
                    }

                    /*d3.select(self.frameElement).style("height", diameter + "px");*/
                }

                d3.selectAll(".filters input").on('click', function(e){
                    drawIt(this.value);
                });
                drawIt();
        </script>
    </body>
</html>